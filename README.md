# 📁 文件操作工具

这是一个为 AstrBot 设计的高级文件管理插件。它赋予大语言模型（LLM）直接操作机器人服务器工作区文件的能力，支持读取并分析多种格式文件，以及生成 Office 文档。

## 🌟 核心特性

- **智能文件分析**：LLM 可读取 Python, JS, HTML, Markdown, JSON 等文本文件，并对内容进行总结、分析，提供帮助或建议。
- **Office 文档生成**：原生支持生成 Word (.docx), Excel (.xlsx) 和 PowerPoint (.pptx) 文件。
- **流式处理**：大文件采用分块读取，避免内存溢出。
- **安全防护**：内置路径验证机制，防止路径遍历攻击。
- **精细权限控制**：
  - **管理员模式**：可限制仅管理员可用。
  - **白名单机制**：支持指定特定用户调用。
  - **群聊安全逻辑**：支持"必须 @ 或引用机器人"才暴露工具，防止群聊误触发及 Token 浪费。

## 🛠️ 安装与配置

### 依赖要求

若需使用 Office 生成功能，请确保安装以下 Python 库：

```bash
pip install python-docx openpyxl python-pptx
```

### 配置项说明

在 AstrBot 管理面板中，你可以配置以下内容：

#### 触发设置

| 配置项               | 类型 | 默认值 | 说明                                                     |
| -------------------- | ---- | ------ | -------------------------------------------------------- |
| 群聊需要@/引用机器人 | bool | true   | 开启后，群聊中仅在@/引用机器人时模型才会获得文件操作能力 |
| 发送文件时@用户      | bool | true   | 发送生成的文件时，是否@用户                              |

#### 权限管理

| 配置项       | 类型 | 默认值 | 说明                                      |
| ------------ | ---- | ------ | ----------------------------------------- |
| 仅管理员可用 | bool | false  | 是否限制只有管理员才能调用文件工具        |
| 用户白名单   | list | []     | 允许使用插件的用户 ID，留空则允许所有用户 |

#### 功能开关

| 配置项               | 类型 | 默认值 | 说明                             |
| -------------------- | ---- | ------ | -------------------------------- |
| 启用 Office 文件生成 | bool | true   | 是否允许生成 Word/Excel/PPT 文件 |

#### 文件限制

| 配置项           | 类型 | 默认值 | 说明                                     |
| ---------------- | ---- | ------ | ---------------------------------------- |
| 最大文件大小(MB) | int  | 50     | 允许读取/发送的最大文件大小              |
| 文本预览大小(KB) | int  | 100    | 读取文本文件时的最大预览大小             |
| 允许的文件扩展名 | list | []     | 允许操作的扩展名列表，留空则允许所有类型 |

## 📖 提供的工具 (LLM Tools)

| 工具名称      | 功能描述                                             |
| ------------- | ---------------------------------------------------- |
| `list_files`  | 查看当前工作区的所有文件详情（名称、大小、修改时间） |
| `read_file`   | 读取文本文件内容，供 LLM 分析并提供总结、建议或帮助  |
| `write_file`  | 生成 Office 文档（Word/Excel/PPT）                   |
| `delete_file` | 永久删除指定文件                                     |

### 支持的文件类型

#### 📖 可读取分析的文件格式

`.txt`, `.md`, `.json`, `.csv`, `.log`, `.py`, `.js`, `.html`, `.css`, `.xml`, `.yaml`, `.yml`等

> LLM 会读取这些文件的内容，并根据用户需求进行：代码审查、内容总结、问题排查、优化建议等。

#### 📝 可生成的文件格式（仅 Office）

| 格式       | 扩展名  | 类型参数     | 说明               |
| ---------- | ------- | ------------ | ------------------ |
| Word       | `.docx` | `word`       | 支持多段落文档生成 |
| Excel      | `.xlsx` | `excel`      | 支持表格数据生成   |
| PowerPoint | `.pptx` | `powerpoint` | 支持多页幻灯片生成 |

> ⚠️ **注意**：本插件仅支持生成 Office 文件，不支持生成普通文本文件（如 .txt, .py 等）。

## 💬 使用示例

与机器人对话即可触发文件操作：

```
用户：看看工作区有什么文件
机器人：📂 工作区文件列表：
       1. main.py (2.1 KB) - 2025-12-25 10:30
       2. config.json (256 B) - 2025-12-25 09:15
       共 2 个文件

用户：帮我看看 main.py 有没有什么问题
机器人：我来分析一下这个文件...

       📋 代码审查结果：
       1. 第15行：建议添加异常处理，避免文件读取失败时程序崩溃
       2. 第23行：变量命名可以更具描述性，如将 `x` 改为 `user_count`
       3. 整体结构良好，但建议将配置项提取到单独的配置文件中
       ...

用户：总结一下 README.md 的主要内容
机器人：📄 文档总结：
       这是一个 xxx 项目，主要功能包括：
       1. ...
       2. ...
       使用方法：...

用户：帮我做一个Excel表格，包含本月销售数据
机器人：好的，我来为你生成 Excel 文件。
       ✅ 文件已处理成功：sales_report.xlsx
       [sales_report.xlsx 文件]
```

## 📝 开发日志

### [2025-12-26] 类型系统修复与代码优化

- 新增 constants.py 模块，集中管理静态常量（OfficeType、TEXT_SUFFIXES、FILE_TOOLS 等）

- read_file 交互模式变更：不再直接发送内容给用户，而是返回给 LLM 处理

- 支持用户用自然语言描述需求（如总结、分析），LLM 智能理解后处理

- 简化配置项：移除 max_read_text_kb 和 allowed_extensions 配置

- 优化 Base64 编码：采用异步分块读取，避免大文件内存溢出

- 私聊场景下跳过工具可见性检查，提升响应速度

### [2025-12-25] 代码优化与重构

- **架构精简**：移除独立的文件生成器类（`file_generator`），将相关逻辑整合至主插件中，减少代码冗余。
- **异步优化**：Office 文件生成器全面支持异步操作，采用流式处理大文件，避免内存溢出。
- **安全增强**：
  - 新增路径验证机制，防止路径遍历攻击。
  - 增加文件大小限制配置，用户可自定义最大文件大小。
- **配置扩展**：新增 `file_settings` 配置组，支持设置最大文件大小(MB)、文本预览大小(KB)及允许的文件扩展名。
- **Bug 修复**：修复 `format_file_size()` 函数对负值和零值的处理问题。

### [2025-12-24] 修正 Office 导包

- 修复了 Office 相关库的导入问题。

### [2025-12-22] 架构重构

- **全面转向工具化**：移除了旧版的 `file_analyzer` 意图识别层，改为通过 `@llm_tool` 暴露能力，显著降低了对话延迟和 Token 消耗。
- **动态注入机制**：实现了基于场景和权限的工具动态隐藏逻辑（`on_llm_request`），在非必要场景下不向模型暴露文件工具。
- **安全加固**：完善了群聊触发逻辑，增加了对"引用/回复机器人消息"的判定支持。

### [早期版本] 初始功能实现

- 支持基础的文本文件读写。
- 集成 `file_generator` 和 `office_generator` 底层引擎。
- 实现基础的 WebUI 配置支持。

## ⚠️ 注意事项

1. **安全性**：所有文件操作均限制在插件工作区目录内，无法访问系统其他目录。
2. **写入限制**：本插件仅支持生成 Office 文档，不支持写入/生成普通文本文件。
3. **文件大小**：建议根据服务器内存合理配置最大文件大小，过大可能导致发送失败。
4. **Office 依赖**：如未安装 Office 相关库，对应格式的生成功能将自动禁用，插件会提示所需的包名。
5. **权限配置**：建议在公开群聊中启用"群聊需要@机器人"选项，避免意外触发。

## 📄 许可证

MIT License

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！
